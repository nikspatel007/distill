# Daily Briefing Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace the Dashboard with a Daily Briefing home page that shows journal brief, intake highlights, publish queue, and seeds — with a human review gate before any publishing.

**Architecture:** Add `brief` field to journal frontmatter and `highlights` to intake frontmatter (generated by LLM alongside the prose). New `/api/home/:date` endpoint aggregates these into a single response. Frontend `index.tsx` renders a card stack. Launchd consolidated to one plist with no auto-publish.

**Tech Stack:** Python (journal/intake prompts), TypeScript/Bun (Hono API + React frontend), Zod schemas, TanStack Query

---

### Task 1: Add `brief` field to journal frontmatter schema

**Files:**
- Modify: `web/shared/schemas.ts:117-126` (JournalFrontmatterSchema)

**Step 1: Update the Zod schema**

In `web/shared/schemas.ts`, add `brief` to `JournalFrontmatterSchema`:

```typescript
export const JournalFrontmatterSchema = z.object({
	date: z.string(),
	type: z.string().default("journal"),
	style: z.string().default("dev-journal"),
	sessions_count: z.number().default(0),
	duration_minutes: z.number().default(0),
	tags: z.array(z.string()).default([]),
	projects: z.array(z.string()).default([]),
	brief: z.array(z.string()).default([]),
	created: z.string().optional(),
});
```

**Step 2: Verify existing tests still pass**

Run: `cd web && NO_COLOR=1 bun test server`
Expected: 180 pass (brief has a default, so existing data works)

**Step 3: Commit**

```bash
git add web/shared/schemas.ts
git commit -m "feat: add brief field to journal frontmatter schema"
```

---

### Task 2: Add `highlights` field to intake frontmatter schema

**Files:**
- Modify: `web/shared/schemas.ts:145-152` (IntakeFrontmatterSchema)

**Step 1: Update the Zod schema**

In `web/shared/schemas.ts`, add `highlights` and fix `item_count` alias:

```typescript
export const IntakeFrontmatterSchema = z.object({
	date: z.string().optional(),
	type: z.string().default("intake"),
	sources: z.array(z.string()).default([]),
	item_count: z.number().default(0),
	items: z.number().default(0),
	tags: z.array(z.string()).default([]),
	highlights: z.array(z.string()).default([]),
	created: z.string().optional(),
});
```

Note: existing intake files use `items:` not `item_count:` in frontmatter — adding both with defaults so the parser handles either.

**Step 2: Verify tests pass**

Run: `cd web && NO_COLOR=1 bun test server`
Expected: 180 pass

**Step 3: Commit**

```bash
git add web/shared/schemas.ts
git commit -m "feat: add highlights field to intake frontmatter schema"
```

---

### Task 3: Add DailyBriefing schemas and types

**Files:**
- Modify: `web/shared/schemas.ts` (add new schemas before inferred types section)

**Step 1: Add the DailyBriefing schemas**

Add these after the `ContentCalendarSchema` block (around line 445), before the `SaveMarkdownSchema`:

```typescript
// --- Daily Briefing ---

export const JournalBriefSchema = z.object({
	brief: z.array(z.string()),
	hasFullEntry: z.boolean(),
	date: z.string(),
	sessionsCount: z.number().default(0),
	durationMinutes: z.number().default(0),
});

export const IntakeBriefSchema = z.object({
	highlights: z.array(z.string()),
	itemCount: z.number(),
	hasFullDigest: z.boolean(),
	date: z.string(),
});

export const BriefingPublishItemSchema = z.object({
	slug: z.string(),
	title: z.string(),
	type: z.enum(["blog", "twitter", "linkedin", "reddit"]),
	status: z.enum(["draft", "approved", "published"]),
});

export const DailyBriefingSchema = z.object({
	date: z.string(),
	journal: JournalBriefSchema,
	intake: IntakeBriefSchema,
	publishQueue: z.array(BriefingPublishItemSchema),
	seeds: z.array(SeedIdeaSchema),
});
```

Add the inferred types alongside the others:

```typescript
export type JournalBrief = z.infer<typeof JournalBriefSchema>;
export type IntakeBrief = z.infer<typeof IntakeBriefSchema>;
export type BriefingPublishItem = z.infer<typeof BriefingPublishItemSchema>;
export type DailyBriefing = z.infer<typeof DailyBriefingSchema>;
```

**Step 2: TypeScript check**

Run: `cd web && npx tsc --noEmit`
Expected: 0 errors

**Step 3: Commit**

```bash
git add web/shared/schemas.ts
git commit -m "feat: add DailyBriefing canonical schemas"
```

---

### Task 4: Create `/api/home/:date` server route

**Files:**
- Create: `web/server/routes/home.ts`
- Modify: `web/server/index.ts:9-12` (add import + mount)

**Step 1: Write the test**

Create `web/server/__tests__/home.test.ts`:

```typescript
import { afterAll, beforeAll, describe, expect, test } from "bun:test";
import { mkdir, rm, writeFile } from "node:fs/promises";
import { join } from "node:path";
import { app } from "../index.js";
import { resetConfig, setConfig } from "../lib/config.js";

const TMP_DIR = join(import.meta.dir, "fixtures", "_tmp_home");

beforeAll(async () => {
	await rm(TMP_DIR, { recursive: true, force: true });
	await mkdir(join(TMP_DIR, "journal"), { recursive: true });
	await mkdir(join(TMP_DIR, "intake"), { recursive: true });
	await mkdir(join(TMP_DIR, "blog"), { recursive: true });

	// Journal with brief
	await writeFile(
		join(TMP_DIR, "journal", "journal-2026-02-22-dev-journal.md"),
		`---
date: 2026-02-22
type: journal
style: dev-journal
sessions_count: 5
duration_minutes: 120
tags:
  - journal
projects:
  - distill
brief:
  - Shipped TLS and PWA support
  - Fixed mobile navigation
  - Consolidated launchd plists
---
# Dev Journal: February 22, 2026

Full narrative here.`,
	);

	// Intake with highlights
	await writeFile(
		join(TMP_DIR, "intake", "intake-2026-02-22.md"),
		`---
date: 2026-02-22
type: intake-digest
items: 12
sources: [rss, session]
tags: [AI, agents]
highlights:
  - Multi-agent workflows are compounding
  - Fibonacci certificates as verification artifacts
  - Agent memory enables faster orientation
---
# The Agent Team That Grew Its Own CMO

Full digest here.`,
	);

	// Seeds file
	await writeFile(
		join(TMP_DIR, ".distill-seeds.json"),
		JSON.stringify([
			{ id: "seed-1", text: "Agent fatigue patterns", tags: [], created_at: "2026-02-22T10:00:00", used: false, used_in: null },
			{ id: "seed-2", text: "Old idea", tags: [], created_at: "2026-02-20T10:00:00", used: true, used_in: "weekly-W08" },
		]),
	);

	setConfig({
		OUTPUT_DIR: TMP_DIR,
		PORT: 6109,
		PROJECT_DIR: "",
		POSTIZ_URL: "",
		POSTIZ_API_KEY: "",
	});
});

afterAll(async () => {
	resetConfig();
	await rm(TMP_DIR, { recursive: true, force: true });
});

describe("Home API", () => {
	test("GET /api/home/2026-02-22 returns daily briefing", async () => {
		const res = await app.request("/api/home/2026-02-22");
		expect(res.status).toBe(200);
		const data = await res.json();

		expect(data.date).toBe("2026-02-22");

		// Journal brief
		expect(data.journal.brief).toHaveLength(3);
		expect(data.journal.brief[0]).toBe("Shipped TLS and PWA support");
		expect(data.journal.hasFullEntry).toBe(true);
		expect(data.journal.sessionsCount).toBe(5);

		// Intake highlights
		expect(data.intake.highlights).toHaveLength(3);
		expect(data.intake.highlights[0]).toBe("Multi-agent workflows are compounding");
		expect(data.intake.hasFullDigest).toBe(true);
		expect(data.intake.itemCount).toBe(12);

		// Seeds (only unused)
		expect(data.seeds).toHaveLength(1);
		expect(data.seeds[0].id).toBe("seed-1");
	});

	test("GET /api/home/today resolves to latest date", async () => {
		const res = await app.request("/api/home/today");
		expect(res.status).toBe(200);
		const data = await res.json();
		expect(data.date).toBe("2026-02-22");
	});

	test("GET /api/home/2025-01-01 returns empty briefing", async () => {
		const res = await app.request("/api/home/2025-01-01");
		expect(res.status).toBe(200);
		const data = await res.json();
		expect(data.journal.brief).toHaveLength(0);
		expect(data.journal.hasFullEntry).toBe(false);
		expect(data.intake.highlights).toHaveLength(0);
		expect(data.intake.hasFullDigest).toBe(false);
	});
});
```

**Step 2: Run test to verify it fails**

Run: `cd web && NO_COLOR=1 bun test server/__tests__/home.test.ts`
Expected: FAIL (route doesn't exist yet)

**Step 3: Write the route**

Create `web/server/routes/home.ts`:

```typescript
import { readFile } from "node:fs/promises";
import { join } from "node:path";
import { Hono } from "hono";
import {
	IntakeFrontmatterSchema,
	JournalFrontmatterSchema,
	type SeedIdea,
} from "../../shared/schemas.js";
import { getConfig } from "../lib/config.js";
import { listFiles, readMarkdown } from "../lib/files.js";
import { parseFrontmatter } from "../lib/frontmatter.js";

const app = new Hono();

/**
 * Find the latest available date from journal files.
 */
async function findLatestDate(outputDir: string): Promise<string | null> {
	const files = await listFiles(join(outputDir, "journal"), /^journal-.*\.md$/);
	if (files.length === 0) return null;
	// Files are named journal-YYYY-MM-DD-*.md — extract dates and sort
	const dates = files
		.map((f) => {
			const match = f.match(/journal-(\d{4}-\d{2}-\d{2})/);
			return match?.[1] ?? null;
		})
		.filter((d): d is string => d !== null)
		.sort()
		.reverse();
	return dates[0] ?? null;
}

app.get("/api/home/:date", async (c) => {
	const { OUTPUT_DIR } = getConfig();
	const dateParam = c.req.param("date");

	// Resolve "today" to latest available date
	const date =
		dateParam === "today" ? ((await findLatestDate(OUTPUT_DIR)) ?? "") : dateParam;

	// Load journal for this date
	const journalFiles = await listFiles(
		join(OUTPUT_DIR, "journal"),
		new RegExp(`^journal-${date}.*\\.md$`),
	);
	let journalBrief: string[] = [];
	let hasFullEntry = false;
	let sessionsCount = 0;
	let durationMinutes = 0;

	if (journalFiles.length > 0 && journalFiles[0]) {
		const raw = await readMarkdown(journalFiles[0]);
		if (raw) {
			hasFullEntry = true;
			const parsed = parseFrontmatter(raw, JournalFrontmatterSchema);
			if (parsed) {
				journalBrief = parsed.frontmatter.brief ?? [];
				sessionsCount = parsed.frontmatter.sessions_count;
				durationMinutes = parsed.frontmatter.duration_minutes;
			}
		}
	}

	// Load intake for this date
	const intakePath = join(OUTPUT_DIR, "intake", `intake-${date}.md`);
	let intakeHighlights: string[] = [];
	let hasFullDigest = false;
	let itemCount = 0;

	const intakeRaw = await readMarkdown(intakePath).catch(() => null);
	if (intakeRaw) {
		hasFullDigest = true;
		const parsed = parseFrontmatter(intakeRaw, IntakeFrontmatterSchema);
		if (parsed) {
			intakeHighlights = parsed.frontmatter.highlights ?? [];
			itemCount = parsed.frontmatter.items ?? parsed.frontmatter.item_count ?? 0;
		}
	}

	// Load seeds (unused only)
	let seeds: SeedIdea[] = [];
	try {
		const seedsRaw = await readFile(join(OUTPUT_DIR, ".distill-seeds.json"), "utf-8");
		const allSeeds = JSON.parse(seedsRaw) as SeedIdea[];
		seeds = allSeeds.filter((s) => !s.used);
	} catch {
		// No seeds file
	}

	// Publish queue — reuse existing publish route logic
	// For now, return empty array; Task 6 will wire this up
	const publishQueue: Array<{
		slug: string;
		title: string;
		type: string;
		status: string;
	}> = [];

	return c.json({
		date,
		journal: {
			brief: journalBrief,
			hasFullEntry,
			date,
			sessionsCount,
			durationMinutes,
		},
		intake: {
			highlights: intakeHighlights,
			itemCount,
			hasFullDigest,
			date,
		},
		publishQueue,
		seeds,
	});
});

export default app;
```

**Step 4: Mount the route in index.ts**

In `web/server/index.ts`, add:

```typescript
import home from "./routes/home.js";
```

And mount it alongside the others:

```typescript
app.route("/", home);
```

**Step 5: Run test to verify it passes**

Run: `cd web && NO_COLOR=1 bun test server/__tests__/home.test.ts`
Expected: 3 pass

**Step 6: Run all server tests**

Run: `cd web && NO_COLOR=1 bun test server`
Expected: 183+ pass

**Step 7: Commit**

```bash
git add web/server/routes/home.ts web/server/__tests__/home.test.ts web/server/index.ts
git commit -m "feat: add /api/home/:date endpoint for daily briefing"
```

---

### Task 5: Wire publish queue into home endpoint

**Files:**
- Modify: `web/server/routes/home.ts` (add publish queue loading from blog state + content store)

**Step 1: Add test for publish queue**

Add to `web/server/__tests__/home.test.ts` beforeAll:

```typescript
// Blog state with a draft post
await mkdir(join(TMP_DIR, "blog"), { recursive: true });
await writeFile(
	join(TMP_DIR, "blog", ".blog-state.json"),
	JSON.stringify({
		posts: [
			{ slug: "weekly-2026-W08", post_type: "weekly", generated_at: "2026-02-22", source_dates: ["2026-02-22"], file_path: "" },
		],
	}),
);
await writeFile(
	join(TMP_DIR, "blog", ".blog-memory.json"),
	JSON.stringify({
		posts: [
			{ slug: "weekly-2026-W08", title: "Week 8 Recap", post_type: "weekly", date: "2026-02-22", key_points: [], themes_covered: [], examples_used: [], platforms_published: [], postiz_ids: [] },
		],
	}),
);
```

Add test:

```typescript
test("publish queue includes blog posts", async () => {
	const res = await app.request("/api/home/2026-02-22");
	const data = await res.json();
	expect(data.publishQueue.length).toBeGreaterThan(0);
	expect(data.publishQueue[0].slug).toBe("weekly-2026-W08");
	expect(data.publishQueue[0].status).toBe("draft");
});
```

**Step 2: Implement publish queue loading in home.ts**

Import `BlogMemorySchema`, `BlogStateSchema` from schemas and `readJson` from files. Load blog state and memory, build publish queue similar to existing `publish.ts` route but with the `BriefingPublishItem` shape.

**Step 3: Run tests**

Run: `cd web && NO_COLOR=1 bun test server/__tests__/home.test.ts`
Expected: 4 pass

**Step 4: Commit**

```bash
git add web/server/routes/home.ts web/server/__tests__/home.test.ts
git commit -m "feat: wire publish queue into daily briefing endpoint"
```

---

### Task 6: Build the Daily Briefing React page

**Files:**
- Rewrite: `web/src/routes/index.tsx`

**Step 1: Write the component**

Replace `web/src/routes/index.tsx` with the Daily Briefing card stack. Key sections:

1. **Date header** with left/right arrows and "Today" button
2. **Journal card** — shows `brief` bullets, "Read more" link to `/journal/:date`
3. **Intake card** — shows `highlights`, item count, link to `/reading/:date`
4. **Publish queue card** — each item with `[Approve]` and `[Edit in Studio]` buttons
5. **Seeds card** — each unused seed with `[Develop]` (→ Studio) and `[Dismiss]` (DELETE /api/seeds/:id)

Use `useQuery` to fetch `/api/home/:date`. Loading/error states follow existing Dashboard pattern.

Mobile-first: full-width cards with `max-w-2xl mx-auto` for desktop. Cards use existing design tokens (`border-zinc-200 dark:border-zinc-800`, `bg-white dark:bg-zinc-900`).

**Step 2: TypeScript check**

Run: `cd web && npx tsc --noEmit`
Expected: 0 errors

**Step 3: Build**

Run: `cd web && bun run build`
Expected: builds successfully

**Step 4: Frontend test**

Add `web/src/__tests__/DailyBriefing.test.tsx` with MSW mock for `/api/home/today` and verify the cards render.

**Step 5: Run all frontend tests**

Run: `cd web && npx vitest run`
Expected: all pass

**Step 6: Commit**

```bash
git add web/src/routes/index.tsx web/src/__tests__/DailyBriefing.test.tsx
git commit -m "feat: replace Dashboard with Daily Briefing home page"
```

---

### Task 7: Extend journal prompt to produce `brief:` in frontmatter

**Files:**
- Modify: `src/journal/prompts.py` (all style prompts)
- Modify: `src/journal/services.py:324-349` (_build_frontmatter)
- Test: `tests/journal/test_services.py`

**Step 1: Update the journal prompt**

Append to each prompt in `JOURNAL_SYSTEM_PROMPTS`:

```
IMPORTANT: Before the prose, output a YAML block with 3-5 brief bullet \
points summarizing what was built/done today. Format:

BRIEF:
- First key accomplishment
- Second key accomplishment
- Third key accomplishment

Then write the full prose as before.
```

**Step 2: Parse the brief from LLM output**

In `src/journal/services.py`, update `format_entry` to extract `BRIEF:` from the LLM prose, parse the bullet points, and inject them into frontmatter as `brief:` YAML list.

Add a helper `_extract_brief(prose: str) -> tuple[list[str], str]` that splits the LLM output into brief bullets and the remaining prose.

**Step 3: Update `_build_frontmatter` to include brief**

```python
def _build_frontmatter(self, context: DailyContext, brief: list[str] | None = None) -> str:
    ...
    if brief:
        lines.append("brief:")
        for item in brief:
            lines.append(f"  - {item}")
    ...
```

**Step 4: Write tests**

Test `_extract_brief` with sample LLM output containing `BRIEF:\n- item1\n- item2\n\nFull prose...`

Test that `_build_frontmatter` includes brief items in output YAML.

**Step 5: Run tests**

Run: `uv run pytest tests/journal/ -x -q`
Expected: all pass

**Step 6: Commit**

```bash
git add src/journal/prompts.py src/journal/services.py tests/journal/test_services.py
git commit -m "feat: journal prompt produces brief bullets in frontmatter"
```

---

### Task 8: Extend intake prompt to produce `highlights:` in frontmatter

**Files:**
- Modify: `src/intake/prompts.py:91+` (get_unified_intake_prompt)
- Modify: `src/intake/publishers/obsidian.py:22-37` (_build_frontmatter)
- Test: `tests/intake/test_publishers.py`

**Step 1: Update the intake prompt**

Add to `get_unified_intake_prompt()` return string:

```
IMPORTANT: Before the essay, output a HIGHLIGHTS block with 3-5 key \
takeaways from today's reading and building. Format:

HIGHLIGHTS:
- First key insight or finding
- Second key insight or finding
- Third key insight or finding

Then write the full essay as before.
```

**Step 2: Parse highlights from LLM output and inject into frontmatter**

Same pattern as Task 7: extract `HIGHLIGHTS:` block, pass to `_build_frontmatter`.

**Step 3: Write tests and run**

Run: `uv run pytest tests/intake/ -x -q`
Expected: all pass

**Step 4: Commit**

```bash
git add src/intake/prompts.py src/intake/publishers/obsidian.py tests/intake/
git commit -m "feat: intake prompt produces highlights in frontmatter"
```

---

### Task 9: Remove auto-publish from pipeline and consolidate launchd

**Files:**
- Modify: `src/core.py` — add `auto_publish: bool = False` gate to `generate_blog_posts` and `generate_intake`
- Modify: `src/cli.py` — `run` command passes `auto_publish=False` by default
- Update: `~/Library/LaunchAgents/com.distill.daily.plist` — remove `--publish` flags
- Delete: `~/Library/LaunchAgents/com.distill.daily-intake.plist`

**Step 1: Check where publishing is triggered in core.py**

Read `src/core.py` to find where publishers are called. Add a `publish` parameter that defaults to False. When False, skip all publisher calls — just generate the markdown files.

**Step 2: Update the launchd plist**

Update `com.distill.daily.plist`:
- Remove `--global` flag (consolidate)
- Remove any `--publish` flags
- Output to `insights/` only
- Keep Ghost/Postiz env vars (needed by the web server for the approve flow)

**Step 3: Unload and remove the duplicate plist**

```bash
launchctl unload ~/Library/LaunchAgents/com.distill.daily-intake.plist
rm ~/Library/LaunchAgents/com.distill.daily-intake.plist
launchctl unload ~/Library/LaunchAgents/com.distill.daily.plist
# (update the file)
launchctl load ~/Library/LaunchAgents/com.distill.daily.plist
```

**Step 4: Verify**

```bash
launchctl list | grep distill
```

Expected: only `com.distill.daily` shows.

**Step 5: Commit**

```bash
git add src/core.py src/cli.py
git commit -m "feat: gate auto-publish behind flag, default to draft-only"
```

---

### Task 10: Rebuild and verify end-to-end

**Files:** None (verification only)

**Step 1: Run all server tests**

Run: `cd web && NO_COLOR=1 bun test server`
Expected: 183+ pass

**Step 2: Run all frontend tests**

Run: `cd web && npx vitest run`
Expected: all pass

**Step 3: TypeScript check**

Run: `cd web && npx tsc --noEmit`
Expected: 0 errors

**Step 4: Build**

Run: `cd web && bun run build`
Expected: builds successfully

**Step 5: Restart server and test**

```bash
kill $(lsof -ti :6107) 2>/dev/null
kill $(lsof -ti :6117) 2>/dev/null
NODE_ENV=production bun web/server/index.ts &
```

Test: `curl -s http://localhost:6107/api/home/today | jq .date`
Expected: returns today's date

Test: open `https://nik-mbp-m4max.taila28aec.ts.net:6117/` on phone
Expected: Daily Briefing card stack renders

**Step 6: Run Python tests for prompt changes**

Run: `uv run pytest tests/journal/ tests/intake/ -x -q`
Expected: all pass
