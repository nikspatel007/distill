workflow: session-insights-dev
description: Development workflow for session-insights CLI tool with failure diagnosis

agents:
  - role: engineer
  - role: reviewer

states:
  start:
    type: initial
    auto_transition: engineering

  engineering:
    instructions: |
      Implement the assigned task for the session-insights CLI tool.

      TASK ALIGNMENT CHECK (do this FIRST, before writing any code):
      Identify which KPI(s) this task will move. If you cannot name at least one
      of the KPIs below that this task directly advances, STOP and signal blocked
      with an explanation. Do not execute tasks that only improve infrastructure
      without moving a metric.

      KPIs (current status):
      - note_content_richness: 0% — CRITICAL, primary bottleneck
      - vermas_task_visibility: partial
      - cli_runs_clean: partial
      - obsidian_compatibility: on track

      PRIORITY ORDER:
      1. note_content_richness (0% — this is the #1 priority)
         The content pipeline is: parser output → structured metadata → formatter rendering → rich CLI output.
         Tasks MUST target one of these pipeline stages. Specifically:
         - Ensure parsed data includes structured metadata (tags, categories, summaries)
         - Ensure formatters render rich content (not just raw text)
         - Ensure CLI commands surface enriched content to the user
         Do NOT create new infrastructure, models, or abstractions unless they
         directly produce richer content output visible to the end user.
      2. vermas_task_visibility — wire real task lifecycle data into existing CLI commands
      3. cli_runs_clean — add end-to-end CLI smoke tests (run each command, check exit code)
      4. New features only after above KPIs are on track

      CRITICAL: NO MORE SCAFFOLDING
      The CLI skeleton and parser are complete and stable. Do NOT create new command
      stubs or placeholder implementations. All work must produce functional code
      that operates on real data.

      BEFORE RETRYING A PREVIOUSLY FAILED TASK:
      You MUST perform root cause analysis first. Identify why the prior attempt
      failed, what has changed since then, and what specific approach will succeed
      this time. Document this in your first message before writing code.

      Follow Python best practices:
      - Use Pydantic v2 for models
      - Click for CLI commands
      - pytest for testing
      - Type hints throughout

      Run tests before signaling done:
      `uv run pytest tests/ -x -q`

      If tests fail, fix them before signaling.

      Signal "done" when implementation is complete and tests pass.
      Signal "blocked" if you cannot map the task to a KPI or encounter infrastructure issues.
    on_signal:
      done:
        from: engineer
        next: reviewing
      blocked:
        from: engineer
        next: blocked
    timeout:
      duration: 30m
      action: nudge

  reviewing:
    instructions: |
      Review the engineer's implementation for the session-insights CLI tool.

      REVIEW CHECKLIST (all must pass):

      1. KPI ALIGNMENT: Does this change directly move at least one KPI?
         - If the change is pure infrastructure with no visible metric impact, request revision.
         - Specifically check: does it improve note_content_richness (the #1 bottleneck)?

      2. FUNCTIONAL COMPLETENESS: Does the code produce real output with real data?
         - No placeholder implementations, stub functions, or TODO comments.
         - Run the affected CLI commands and verify they produce meaningful output.

      3. CODE QUALITY:
         - Type hints present
         - Tests exist and pass: `uv run pytest tests/ -x -q`
         - No obvious bugs or regressions

      4. CONTENT PIPELINE (if task targets note_content_richness):
         - Verify the full path: parsed data → structured metadata → formatted output
         - Confirm the enriched content is visible in CLI output, not just stored internally

      Signal "approved" if all checks pass.
      Signal "needs_revision" with specific feedback if any check fails.
      Focus feedback on the highest-impact issue first.
    on_signal:
      approved:
        from: reviewer
        next: finalize
      needs_revision:
        from: reviewer
        next: engineering
    timeout:
      duration: 15m
      action: nudge

  finalize:
    on_entry:
      - action: commit
    type: terminal

  blocked:
    on_entry:
      - action: log
        message: "Workflow blocked - task not KPI-aligned, environment validation failed, or infrastructure issue"
    type: terminal
