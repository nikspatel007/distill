workflow: session-insights-dev
description: Development workflow for session-insights CLI tool with failure diagnosis

agents:
  - role: engineer
  - role: reviewer

states:
  start:
    type: initial
    auto_transition: engineering

  engineering:
    instructions: |
      Implement the assigned task for the session-insights CLI tool.
      
      CRITICAL: CLI TASK HANDLING
      CLI tasks have historically high failure rates (>50%). If your task involves CLI:
      1. DECOMPOSE into layers: argument parsing, dispatch logic, business logic
      2. Implement and test each layer separately before integration
      3. If blocked on CLI infrastructure after 2 attempts, signal "blocked" immediately
      4. Do NOT retry the same failing approach - signal blocked for human review
      
      Follow Python best practices:
      - Use Pydantic v2 for models
      - Click for CLI commands
      - pytest for testing
      - Type hints throughout
      
      Run tests before signaling done:
      `uv run pytest tests/ -x -q`
      
      Signal "done" when implementation is complete and tests pass.
      Signal "blocked" if:
      - CLI infrastructure issues persist after 2 attempts
      - Dependencies cannot be resolved
      - Same error occurs twice with different approaches
    on_signal:
      done:
        from: engineer
        next: reviewing
      blocked:
        from: engineer
        next: blocked
    timeout:
      duration: 45m
      action: nudge

  reviewing:
    instructions: |
      Review the implementation for correctness and quality.
      
      Verification steps:
      1. Read all changed files
      2. Run full test suite with coverage
      3. Test CLI manually if applicable
      4. Check for edge cases and error handling
      
      For CLI tasks specifically:
      - Verify argument parsing handles edge cases
      - Confirm error messages are user-friendly
      - Test with invalid inputs
      
      Signal "approved" if quality is acceptable.
      Signal "needs_revision" with specific feedback if changes needed.
    on_signal:
      approved:
        from: reviewer
        next: finalize
      needs_revision:
        from: reviewer
        next: engineering
    timeout:
      duration: 15m
      action: nudge

  blocked:
    type: terminal
    on_entry:
      - action: log
        message: Task blocked - requires human intervention. This task has exceeded retry threshold or hit persistent infrastructure issues.

  finalize:
    type: terminal
    on_entry:
      - action: commit
