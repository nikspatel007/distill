workflow: session-insights-dev
description: Development workflow for session-insights CLI tool with failure diagnosis

agents:
  - role: engineer
  - role: reviewer

states:
  start:
    type: initial
    auto_transition: engineering

  engineering:
    instructions: |
      Implement the assigned task for the session-insights CLI tool.
      
      CRITICAL PHASE DIRECTIVE:
      Foundation scaffolding is COMPLETE as of cycle 3. All tasks must now
      prioritize FEATURE IMPLEMENTATION over infrastructure work:
      - Implement actual parsing logic (markdown, Obsidian features)
      - Add integration tests against real documents
      - Target 10%+ KPI gain per cycle (3 tasks = 10% minimum)
      
      DO NOT spend time on:
      - Additional scaffolding or project structure
      - Abstract base classes without concrete implementations
      - Infrastructure work that doesn't directly move parse_success_rate
      
      Follow Python best practices:
      - Use Pydantic v2 for models
      - Click for CLI commands
      - pytest for testing
      - Type hints throughout
      
      CLI Task Decomposition (HIGH-RISK AREA):
      CLI implementation has caused multiple cycle failures. If your task involves CLI:
      1. NEVER implement argument parsing, dispatch, and business logic together
      2. Break into discrete layers:
         - Layer 1: Argument/option parsing with Click decorators
         - Layer 2: Command dispatch and routing
         - Layer 3: Business logic (call existing parser/analysis functions)
      3. Implement and test ONE layer per task
      4. If a CLI task fails, signal blocked rather than retry the same approach
      
      Run tests before signaling done:
      `uv run pytest tests/ -x -q`
      
      If tests fail, fix them before signaling.
      
      Signal "done" when implementation is complete and tests pass.
      Signal "blocked" if you encounter infrastructure issues or are stuck.
    on_signal:
      done:
        from: engineer
        next: reviewing
      blocked:
        from: engineer
        next: blocked
    timeout:
      duration: 30m
      action: nudge

  reviewing:
    instructions: |
      Review the engineer's implementation for the session-insights CLI tool.
      
      Review criteria:
      1. Does this task move KPI (parse_success_rate) meaningfully?
         - If it's pure infrastructure with no KPI impact, request revision
      2. Are tests present and passing?
      3. Does the code follow Python best practices?
      4. For CLI changes: are the three layers properly separated?
      
      Signal "approved" if the implementation is correct and impactful.
      Signal "needs_revision" with specific feedback if changes needed.
    on_signal:
      approved:
        from: reviewer
        next: finalize
      needs_revision:
        from: reviewer
        next: engineering
    timeout:
      duration: 15m
      action: nudge

  finalize:
    type: terminal
    on_entry:
      - action: commit

  blocked:
    type: terminal
    on_entry:
      - action: log
        message: Workflow blocked - requires manual intervention
